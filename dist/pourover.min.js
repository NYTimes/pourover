!function(t,e){"function"==typeof define&&define.amd?define(["underscore"],e):"object"==typeof exports?module.exports=e(require("underscore")):t.PourOver=e(t._)}(this,function(t){var e=function(){var i=function(){},n=t.create||function(t){i.prototype=t;var e=new i;return i.prototype=null,e};e={union_sorted:function(e,i){for(var n,r,s=0,c=0,a=e.length,o=i.length,u=[];a>s||o>c;){if(n=e[s],r=i[c],t.isUndefined(n)&&(n=1/0),t.isUndefined(r)&&(r=1/0),s==a)return u.concat(i.slice(c,o));if(c==o)return u.concat(e.slice(s,a));n==r?(u.push(n),s++,c++):r>n?(u.push(n),s++):(u.push(r),c++)}return u},intersect_sorted:function(t,e){for(var i,n,r=0,s=0,c=t.length,a=e.length,o=[];c>r&&a>s;)i=t[r],n=e[s],i==n?(o.push(i),r++,s++):n>i?r++:s++;return o},subtract_sorted:function(t,e){for(var i,n,r=0,s=0,c=t.length,a=e.length,o=[];c>r||a>s;){if(i=t[r],n=e[s],c==r)return o;if(a==s)return o.concat(t.slice(r,c));i==n?(r++,s++):n>i?(o.push(i),r++):s++}return o},insert_sorted:function(t,e){var i=t.length,n=0,r=t[i-1];if(e>r)return t.push(e),t;for(;i>n;){if(e<t[n])return t.slice(0,n).concat([e]).concat(t.slice(n,i));n++}return t.push(e),t},build_permutation_array:function(e,i){var n=t.clone(e),r=[];return n.sort("function"==typeof i?i:function(t,e){return i.fn.call(i,t,e)}),t.each(n,function(t,e){r[t.cid]=e}),r},permute_from_array:function(e,i){var n=[];return"number"==typeof e[0]?t.each(e,function(t){n[i[t]]=t}):t.each(e,function(t){n[i[t.cid]]=t}),t.without(n,void 0)},remove_sorted:function(t,e){for(var i=t.length,n=0;i>n;){if(e==t[n])return t.slice(0,n).concat(t.slice(n+1,i));n++}return t},bisect_by:function(t){function e(e,i,n,r){for(;r>n;){var s=n+r>>>1;t(e[s])<i?n=s+1:r=s}return n}function i(e,i,n,r){for(;r>n;){var s=n+r>>>1;i<t(e[s])?r=s:n=s+1}return n}return i.right=i,i.left=e,i},cacheMethods:{defaultCache:function(e){var i=this;t.each(i.possibilities,function(n){var r=t.filter(e,function(t){return i.fn(n,t)}),s=t.pluck(r,"cid");n.matching_cids=s})},defaultAddCache:function(i){var n=this;t.each(n.possibilities,function(r){var s=t.filter(i,function(t){return n.fn(r,t)}),c=t.pluck(s,"cid");r.matching_cids=e.union_sorted(r.matching_cids,c)})},exactCache:function(i){var n=this,r=this.attr||this.name;t.each(i,function(t){var i=n.possibilities[t[r]];i&&(i.matching_cids=e.insert_sorted(i.matching_cids,t.cid))})},exactAddCache:function(t){e.cacheMethods.exactCache.call(this,t)},inclusionCache:function(i){var n=this,r=this.attr||this.name;t.each(i,function(i){t.each(i[r],function(t){var r=n.possibilities[t];r&&(r.matching_cids=e.insert_sorted(r.matching_cids,i.cid))})})},inclusionAddCache:function(t){e.cacheMethods.inclusionCache.call(this,t)}}};var r=[],s=(r.push,r.slice),c=(r.splice,e.Events={on:function(t,e,i){if(!o(this,"on",t,[e,i])||!e)return this;this._events||(this._events={});var n=this._events[t]||(this._events[t]=[]);return n.push({callback:e,context:i,ctx:i||this}),this},once:function(e,i,n){if(!o(this,"once",e,[i,n])||!i)return this;var r=this,s=t.once(function(){r.off(e,s),i.apply(this,arguments)});return s._callback=i,this.on(e,s,n)},off:function(e,i,n){var r,s,c,a,u,h,f,l;if(!this._events||!o(this,"off",e,[i,n]))return this;if(!e&&!i&&!n)return this._events=void 0,this;for(a=e?[e]:t.keys(this._events),u=0,h=a.length;h>u;u++)if(e=a[u],c=this._events[e]){if(this._events[e]=r=[],i||n)for(f=0,l=c.length;l>f;f++)s=c[f],(i&&i!==s.callback&&i!==s.callback._callback||n&&n!==s.context)&&r.push(s);r.length||delete this._events[e]}return this},trigger:function(t){if(!this._events)return this;var e=s.call(arguments,1);if(!o(this,"trigger",t,e))return this;var i=this._events[t],n=this._events.all;return i&&u(i,e),n&&u(n,arguments),this},stopListening:function(e,i,n){var r=this._listeningTo;if(!r)return this;var s=!i&&!n;n||"object"!=typeof i||(n=this),e&&((r={})[e._listenId]=e);for(var c in r)e=r[c],e.off(i,n,this),(s||t.isEmpty(e._events))&&delete this._listeningTo[c];return this}}),a=/\s+/,o=function(t,e,i,n){if(!i)return!0;if("object"==typeof i){for(var r in i)t[e].apply(t,[r,i[r]].concat(n));return!1}if(a.test(i)){for(var s=i.split(a),c=0,o=s.length;o>c;c++)t[e].apply(t,[s[c]].concat(n));return!1}return!0},u=function(t,e){var i,n=-1,r=t.length,s=e[0],c=e[1],a=e[2];switch(e.length){case 0:for(;++n<r;)(i=t[n]).callback.call(i.ctx);return;case 1:for(;++n<r;)(i=t[n]).callback.call(i.ctx,s);return;case 2:for(;++n<r;)(i=t[n]).callback.call(i.ctx,s,c);return;case 3:for(;++n<r;)(i=t[n]).callback.call(i.ctx,s,c,a);return;default:for(;++n<r;)(i=t[n]).callback.apply(i.ctx,e);return}},h={listenTo:"on",listenToOnce:"once"};return t.each(h,function(e,i){c[i]=function(i,n,r){var s=this._listeningTo||(this._listeningTo={}),c=i._listenId||(i._listenId=t.uniqueId("l"));return s[c]=i,r||"object"!=typeof n||(r=this),i[e](n,r,this),this}}),c.bind=c.on,c.unbind=c.off,t.extend(e,c),e.Collection=function(e,i){"undefined"==typeof e&&(e=[]),this.items=[],this.filters={},this.sorts={},this.addItems(e),this.on("change",function(){t.each(this.filters,function(t){t.current_query&&t.current_query.refresh()})}),this.initialize.apply(this,arguments)},t.extend(e.Collection.prototype,e.Events,{initialize:function(){},refresh:function(){this.trigger("queryChange")},get:function(t){return e.Collection.prototype.getBy.call(this,"cid",t,!0)},getBy:function(e,i,n){if(!t.isArray(i))var i=[i];"undefined"==typeof n&&(n=!1);var r,s=0,c=this.items.length,a=0,o=i.length,u=[],h=this.items;if(1==n)for(;c>s&&o>a;)i[a]==(r=h[s])[e]?(u.push(r),s++,a++):i[a]<r[e]?a++:s++;else if("reverse"==n)for(;c>s&&o>a;)i[a]==(r=h[s])[e]?(u.push(r),s++,a++):i[a]>r[e]?a++:s++;else for(;c>s&&o>a;)t.include(i,(r=h[s])[e])?(u.push(r),i=t.without(i,r[e]),s++,a++):s++;return u},getByFirst:function(t,e,i){"undefined"==typeof i&&(i=!1);var n,r=0,s=this.items.length,c=void 0,a=this.items;if(1==i)for(;s>r;){if(e==(n=a[r])[t]){c=n;break}if(e<n[t])break;r++}else if("reverse"==i)for(;s>r;){if(e==(n=a[r])[t]){c=n;break}if(e>n[t])break;r++}else for(;s>r;){if(e==(n=a[r])[t]){c=n;break}r++}return c},addItems:function(i){this.trigger("will_change"),t.isArray(i)||(i=[i]);var n,r=this.items.length>0?t.last(this.items).cid+1:0;n=t.map(i,function(t){var i=e.Item(t);return i.cid=r++,i}),this.items=this.items.concat(n),this.regenerateFilterSets(n),this.trigger("change",t(n).pluck("cid"))},removeItems:function(e,i){if(this.trigger("will_change"),"undefined"==typeof i)var i=!1;if(!t.isArray(e))var e=[e];if(i){e=e.sort(function(t,e){return t.cid-e.cid});for(var n=[],r=this.items,s=e.length,c=this.items.length,a=0,o=0;c>o;){if(s>!a){n=n.concat(r.slice(o));break}r[o].cid===e[a].cid?(a++,o++):(n.push(r[o]),o++)}}else for(var n=[],r=this.items,c=this.items.length,o=0,u=t.pluck(e,"cid");c>o&&u.length>0;)t.include(u,r[o].cid)||n.push(r[o]),o++;this.items=n,this.regenerateFilterSets(),this.trigger("change",t(e).pluck("cid"))},addFilters:function(e){var i,r=this;t.isArray(e)||(e=[e]),i=t.reduce(e,function(t,e){return t[e.name]=n(e),t[e.name].collection=r,t},{}),this.filters=t.extend(this.filters,i),t.each(i,function(e){e.on("queryChange",function(){r.trigger("queryChange")}),e.cacheResults(r.items),e.associated_attrs&&t.each(e.associated_attrs,function(t){r.on("change:"+t,function(t){e.removeFromCache(t),e.addCacheResults(t),e.current_query&&e.current_query.refresh()})})})},regenerateFilterSets:function(e){var i=this;"undefined"==typeof e?t.each(this.filters,function(t){t.cacheResults(i.items)}):t.each(this.filters,function(t){t.addCacheResults(e)})},getAllItems:function(){var i=t.pluck(this.items,"cid");return new e.MatchSet(i,this,["all"])},getCurrentFilteredItems:function(t,i){return"undefined"==typeof i&&(i=!1),this.filters[t].current_query&&this.filters[t].current_query.stack.length>0?this.filters[t].current_query:i?new e.MatchSet([],this,[]):this.getAllItems()},getFilteredItems:function(e,i){var n=this.filters[e];if(t.isUndefined(n))throw"The filter "+e+" does not exist.";return n.getFn(i)},addSort:function(e){var i=this;this.sorts[e.name]=e,e.collection=this,e.rebuild_sort(),this.on("change",function(){e.rebuild_sort(!0)}),e.associated_attrs&&t.each(e.associated_attrs,function(t){i.on("change:"+t,function(t){e.rebuild_sort()})})},addSorts:function(e){"undefined"==typeof opts&&(opts={}),t.isArray(e)||(e=[e]);var i=this;t.each(e,function(t){i.addSort(t)})},getSortedItems:function(t){var e=this.sorts[t];return e.sort(this.items)},getItemValue:function(e,i){var n=t.find(this.items,function(t){return t.cid===Number(e)});return n[i]},updateItem:function(e,i,n){this.trigger("will_incremental_change");var r=t.find(this.items,function(t){return t.cid===Number(e)});return r[i]=n,this.trigger("change:"+i,[r]),this.trigger("incremental_change",[i]),this.trigger("update","updateItem"),r.guid},removeItemAttribute:function(e,i,n){this.trigger("will_incremental_change");var r=t.find(this.items,function(t){return t.cid===Number(e)});return delete r[i],this.trigger("change:"+i,[r]),this.trigger("incremental_change",[i]),this.trigger("update","updateItem"),r.guid},batchUpdateItems:function(e,i,n){this.trigger("will_incremental_change");var r=this.get(e,!0);return t.each(r,function(t){t[i]=n}),this.trigger("change:"+i,r),this.trigger("incremental_change",[i]),this.trigger("update","batchUpdate"),t.pluck(r,"guid")},updateAttributes:function(e,i,n){if("undefined"==typeof n)var n=!1;this.trigger("will_incremental_change");var r=t.find(this.items,function(t){return t.cid===Number(e)}),s=this;return t.each(i,function(t,e){r[e]=t,s.trigger("change:"+e,[r])}),this.trigger("incremental_change",t.keys(i)),n||this.trigger("update","updateAttribute"),r.guid},batchUpdateAttributes:function(e,i,n){if("undefined"==typeof n)var n=!1;this.trigger("will_incremental_change");var r=this.get(e,!0),s=this;return t.each(r,function(e){t.each(i,function(t,i){e[i]=t})}),t.each(i,function(t,e){s.trigger("change:"+e,r)}),this.trigger("incremental_change",t.keys(i)),n||(this.trigger("update","batchUpdate"),this.trigger("batchUpdateAttribute")),t.pluck(r,"guid")},batchLoadItems:function(i){this.trigger("will_incremental_change");var n=[],r=t.pluck(i,"guid"),s=this.getBy("guid",r),c={};t(s).each(function(t){c[t.guid]=t}),t.each(i,t.bind(function(i){var r,a=c[i.guid],o=this.items.length>0?t(this.items).last().cid+1:0;a?(r=a,t.each(i,function(t,e){r[e]=t})):(a=e.Item(i),a.cid=o++,n.push(a.cid),this.items=this.items.concat([a]),s[a.guid]=a)},this)),this.regenerateFilterSets(),this.trigger("incremental_change","*"),this.trigger("change",n),this.trigger("update","batchLoad"),this.trigger("batchLoadItems")}}),e.Item=function(t){return t},e.Filter=function(e,i,n){"undefined"==typeof n&&(n={}),this.name=e,this.possibilities=this.create_possibilities(i),this.values=t.pluck(i,"value"),t.extend(this,n),this.initialize.apply(this,arguments)},t.extend(e.Filter.prototype,e.Events,{initialize:function(){},create_possibilities:function(e){var i={};return t.each(e,function(t){var e=t.name||String(t.value);i[e]=t,i[e].matching_cids=[]}),i},cacheResults:function(t){throw"No cache function has been defined for this filter '"+this.name+"'."},addCacheResults:function(t){throw"No add cache function has been defined for this filter '"+this.name+"'."},makeQueryMatchSet:function(t,i){return new e.MatchSet(t,this.getCollection(),[[this,i]])},removeFromCache:function(i){var n=t.pluck(i,"cid").sort(function(t,e){return t-e});t.each(this.possibilities,function(t){t.matching_cids=e.subtract_sorted(t.matching_cids,n)})},query:function(t,e){if("undefined"==typeof e)var e=!1;var i=this.getFn(t);this.setQuery(i,e)},setQuery:function(t,e){if("undefined"==typeof e)var e=!1;this.current_query=t,e||this.trigger("queryChange")},clearQuery:function(t){if("undefined"==typeof t)var t=!1;this.current_query=!1,t||this.trigger("queryChange")},unionQuery:function(e,i){if("undefined"==typeof i)var i=!1;if("string"==typeof e||"number"==typeof e||t.isArray(e))var e=this.getFn(e);this.current_query=this.current_query?this.current_query.or(e):e,i||this.trigger("queryChange")},intersectQuery:function(e,i){if("undefined"==typeof i)var i=!1;if("string"==typeof e||"number"==typeof e||t.isArray(e))var e=this.getFn(e);this.current_query=this.current_query?this.current_query.and(e):e,i||this.trigger("queryChange")},subtractQuery:function(e,i){if("undefined"==typeof i)var i=!1;if("string"==typeof e||"number"==typeof e||t.isArray(e))var e=this.getFn(e);this.current_query=this.current_query?this.current_query.not(e):e,i||this.trigger("queryChange")},removeSingleQuery:function(e,i){if(!this.current_query)return!1;if("undefined"==typeof i)var i=!1;if("string"==typeof e||"number"==typeof e||t.isArray(e))var e=this.getFn(e);var n,r=[],s=this.current_query.stack,c=function(e){return t.isString(e)&&e.match(/^(or|and|not)$/)};n=t.reduce(s,function(t,i){return i[1]===e.stack[0][1]?t:c(i[0])&&i[1][0][1]===e.stack[0][1]?t:(t.push(i),t)},r),!n[0]||"and"!=n[0][0]&&"or"!=n[0][0]&&"not"!=n[0][0]||(n[0]=n[0][1][0]),this.current_query.stack=n,this.current_query.refresh(),i||this.trigger("queryChange")},getCollection:function(){return this.collection},getByPossibilityGroups:function(){var e=this.collection;return t.reduce(this.possibilities,function(t,i,n){return t[n]=e.get(i.matching_cids),t},{})}}),e.Sort=function(e,i){this.name=e,t.extend(this,i),this.initialize.apply(this,arguments)},t.extend(e.Sort.prototype,e.Events,{initialize:function(){},view:!1,sort:function(t){return e.permute_from_array(t,this.permutation_array)},rebuild_sort:function(t){if("undefined"==typeof t&&(t=!1),this.view)var i=this.view.match_set.all();else var i=this.collection.items;this.permutation_array=e.build_permutation_array(i,this),this.trigger("resort",t)}}),e.View=function(i,n,r){var s=this;this.name=i,"undefined"==typeof r&&(r={}),this.collection=n,this.match_set=new e.MatchSet(t.pluck(this.collection.items,"cid"),this.collection,["all"]),r.template&&(this.template=r.template),this.collection.on("will_change will_incremental_change",function(){s.storeViewPosition()}),this.collection.on("change",function(){s.match_set.refresh(),s.setNaturalSelection(),s.resetPage(),s.trigger("collection-change")}),this.collection.on("incremental_change",function(t){s.match_set.refresh(),s.setNaturalSelection(t),s.resetPage(),s.trigger("collection-incremental-change")}),this.collection.on("update",function(t){s.trigger("update",t)}),this.collection.on("queryChange",function(){s.setNaturalSelection(),s.trigger("update","query")}),this.on("sortChange",function(){this.trigger("update","sort")}),this.on("pageChange",function(){this.trigger("update","page")}),this.view_sorts=[],t.extend(this,r),this.initialize.apply(this,arguments)},t.extend(e.View.prototype,e.Events,{initialize:function(){},current_page:0,page_size:1/0,current_sort:!1,removeSort:function(){this.current_sort.off&&this.current_sort.off("resort"),this.current_sort=!1,this.trigger("sortChange")},setSort:function(e,i,n){"undefined"==typeof i&&(i=!1),"undefined"==typeof n&&(n=!1);var r=this;this.current_sort.off&&this.current_sort.off("resort"),e&&i?(this.current_sort=this.view_sorts[e],this.current_sort.on("resort",t.bind(function(t){this.silent_sort&&t||r.trigger("sortChange")},this))):e?(this.current_sort=this.collection.sorts[e],this.current_sort.on("resort",t.bind(function(t){this.silent_sort&&t||r.trigger("sortChange")},this))):this.current_sort=!1,n||this.trigger("sortChange")},getSort:function(){return this.current_sort?this.current_sort.name:!1},addViewSorts:function(e){"undefined"==typeof opts&&(opts={}),t.isArray(e)||(e=[e]);var i=this;t.each(e,function(e){i.view_sorts[e.name]=e,e.collection=i.collection,e.view=i,e.rebuild_sort(),i.on("selectionChange",function(i){(void 0==e.associated_attrs||"*"===i)&&e.rebuild_sort(),e.associated_attrs&&t.intersection(e.associated_attrs,i).length>0&&e.rebuild_sort()})})},selectionFn:function(){var e=this.collection;if(t.isEmpty(e.filters))return e.getAllItems();var i=t.reduce(e.filters,function(i,n){var r=n.current_query;return!i||r&&!t.isEmpty(r.stack)?i||r&&!t.isEmpty(r.stack)?i?i.and(r):r:e.getAllItems():i},!1);return i},setSelection:function(t,e){this.match_set=t,this.trigger("selectionChange",e)},setNaturalSelection:function(t){var e;e=this.selectionFn(),this.setSelection(e,t)},clearSelection:function(){this.match_set=this.collection.getAllItems()},getCurrentItems:function(e){if(!this.match_set)return[];if("undefined"==typeof e)var e=this.current_page;if(this.page_size==1/0)if(this.current_sort)var i=this.match_set.all_sorted(this.current_sort);else var i=this.match_set.all();else if(this.current_sort){var i=this.match_set.all_sorted_cids(this.current_sort);i=i.slice(this.page_size*e,this.page_size*(e+1));var n=t.clone(i).sort(function(t,e){return t-e}),r=this.collection.get(n);i=t.map(i,function(e){return t.findWhere(r,{cid:e})})}else{var i=this.match_set.cids;i=i.slice(this.page_size*e,this.page_size*(e+1)),i=this.collection.get(i)}return i},storeViewPosition:function(){var t=this.getCurrentItems()[0];t&&(this.last_head_cid=t.cid)},resetPage:function(){this.last_head_cid&&(this.current_sort&&this.current_sort.rebuild_sort(),this.pageTo(this.last_head_cid,!0)),this.last_head_cid=void 0},page:function(t){var e=t+this.current_page;0>e&&(e=0),e>Math.ceil(this.match_set.length()/this.page_size-1)&&(e=Math.ceil(this.match_set.length()/this.page_size-1)),this.current_page=e,this.trigger("pageChange")},pageTo:function(e,i){if("undefined"==typeof i)var i=!1;if(this.current_sort)var n=t.indexOf(this.match_set.all_sorted_cids(this.current_sort),e),r=(this.match_set.cids.length,Math.floor(n/this.page_size));else var n=t.indexOf(this.match_set.cids,e),r=(this.match_set.cids.length,Math.floor(n/this.page_size));n>=0&&(this.current_page=r,i||this.trigger("pageChange"))},setPage:function(t){0>t&&(t=0),t>Math.ceil(this.match_set.length()/this.page_size-1)&&(t=Math.ceil(this.match_set.length()/this.page_size-1)),this.current_page=t,this.trigger("pageChange")},setPageSize:function(t){this.page_size=t,this.trigger("pageChange")},render:function(){}}),e.MatchSet=function(t,e,i){this.cids=t,this.collection=e,this.stack=i,this.initialize.apply(this,arguments)},t.extend(e.MatchSet.prototype,e.Events,{initialize:function(){},refresh:function(i,n){if("undefined"==typeof i)var i=this.stack||[];if(i.length<1&&n)return this.cids=n.cids,this;if(i.length<1)return this.cids=!1,this;var r=i[0],s=r[0],c=function(e){return t.isString(e)&&e.match(/^(or|and|not)$/)};if("object"==typeof s)return n=s.getFn(r[1]),this.refresh(t.rest(i),n);if("all"===s||"all"===r){var a=t.pluck(this.collection.items,"cid");return n=new e.MatchSet(a,this,["all"]),this.refresh(t.rest(i),n)}if(c(s))var o=n[s](this.refresh(r[1]));else var o=this.refresh(r[1]);return this.refresh(t.rest(i),o)},and:function(t){if(this.stack.length<1&&t)return t;if(t){var i=e.intersect_sorted(this.cids,t.cids);return new e.MatchSet(i,this.collection,this.stack.concat([["and",t.stack]]))}return this},or:function(t){if(this.stack.length<1&&t)return t;if(t){var i=e.union_sorted(this.cids,t.cids);return new e.MatchSet(i,this.collection,this.stack.concat([["or",t.stack]]))}return this},not:function(t){if(this.stack.length<1||!t)return this;var i=e.subtract_sorted(this.cids,t.cids);return new e.MatchSet(i,this.collection,this.stack.concat([["not",t.stack]]))},all:function(){return this.collection.get(this.cids)},slice:function(t,e){return this.collection.get(this.cids.slice(t,e))},all_sorted:function(t){var e=this.all();return t?t.sort(e):e},all_sorted_cids:function(t){var e=this.cids;return t?t.sort(e):e},length:function(){return this.cids.length}}),e.UI={},e.UI.Element=function(e){if("undefined"==typeof e)var e={};t.extend(this,e),this.initialize.apply(this,arguments)},t.extend(e.UI.Element.prototype,e.Events,{initialize:function(){},getMatchSet:function(){throw"No get match set function specified"},getFilterState:function(){throw"No get filter state specified"},template:function(){throw"No template specified"},render:function(){var t=this.getFilterState(),e=this.template({state:t});return e},getSimpleSelectState:function(e,i,n){if("undefined"==typeof e||!e||!e.stack)return!1;if("undefined"==typeof i&&(i=e.stack),"undefined"==typeof n&&(n=[]),i.length<1)return n;if("object"==typeof i[0][0])return n.push(i[0][1]),this.getSimpleSelectState(e,t.rest(i),n);if("or"===i[0][0])return n=n.concat(this.getSimpleSelectState(e,i[0][1])),this.getSimpleSelectState(e,t.rest(i),n);throw"This does not appear to be a valid, simple selectElement stack."},getIntersectedSelectState:function(e,i,n){if("undefined"==typeof e||!e||!e.stack)return!1;if("undefined"==typeof i&&(i=e.stack),"undefined"==typeof n&&(n=[]),i.length<1)return n;if("object"==typeof i[0][0])return n.push(i[0][1]),this.getIntersectedSelectState(e,t.rest(i),n);if("and"===i[0][0])return n=n.concat(this.getIntersectedSelectState(e,i[0][1])),this.getIntersectedSelectState(e,t.rest(i),n);throw"This does not appear to be a valid, simple selectElement stack."},getSimpleRangeState:function(t){if("undefined"==typeof t||!t||!t.stack)return!1;if(stack=t.stack,1!==stack.length||2!==stack[0][1].length)throw"The filter specified does not appear to have a simple range stack.";return stack[0][1]}}),e.extend=function(e,i){var n,r=this;n=e&&t.has(e,"constructor")?e.constructor:function(){return r.apply(this,arguments)},t.extend(n,r,i);var s=function(){this.constructor=n};return s.prototype=r.prototype,n.prototype=new s,e&&t.extend(n.prototype,e),n.__super__=r.prototype,n},e.Collection.extend=e.View.extend=e.Filter.extend=e.Sort.extend=e.MatchSet.extend=e.UI.Element.extend=e.extend,e.BufferedCollection=e.Collection.extend({initialize:function(){this.buffered_items={}},stripFutures:function(e){return t.reduce(e,function(t,e,i){return"undefined"!=typeof e&&(t[i]=e),t},{})},get:function(i,n){"undefined"==typeof n&&(n=!1);var r=e.Collection.prototype.get.call(this,i),s=this;return n?r:t.map(r,function(e){var i=e.guid;return s.buffered_items.hasOwnProperty(i)?t.extend(s.buffered_items[i],s.stripFutures(e)):e})},getBy:function(i,n,r,s){"undefined"==typeof s&&(s=!1);var c=e.Collection.prototype.getBy.call(this,i,n,r),a=this;return s?c:t.map(c,function(e){var i=e.guid;return a.buffered_items.hasOwnProperty(i)?t.extend(a.buffered_items[i],a.stripFutures(e)):e})},getBufferedValue:function(t,e){return this.buffered_items.hasOwnProperty(t)?this.buffered_items[t][e]||!1:!1},clearBufferedItems:function(){var t=this.buffered_items;for(var e in t)t.hasOwnProperty(e)&&delete t[e]},getBufferUrl:function(t){throw"You must override getBufferUrl;"},preprocessItem:function(t){return[t.guid,t]},bufferGuids:function(e){var i=this;e=t.select(e,function(t){return t&&!i.buffered_items.hasOwnProperty(t)});{var n=this.getBufferUrl(e),r=n[0];n[1]}return e.length>0?$.ajax({url:r,dataType:"jsonp",cache:!0}).always(function(e){t.isArray(e)&&(items=t.map(e,i.preprocessItem,i),t.each(items,function(t){i.buffered_items[t[0]]=t[1]}))}):$.Deferred().resolve(!1)}}),e.BufferedView=e.View.extend({buffer_pages:1,bufferAroundCurrentPage:function(){var e=this.current_page,i=e-this.buffer_pages>0?e-this.buffer_pages:0,n=e+this.buffer_pages,r=t.range(i,n+1),s=this;r=t.map(r,function(e){return t.pluck(s.getCurrentItems(e),"guid")});var c=t.flatten(r);buffer_deferred=this.collection.bufferGuids(c),buffer_deferred.done(function(t){t&&s.render()})},bufferRender:function(){var e=t.pluck(this.getCurrentItems(),"guid"),i=this.collection.bufferGuids(e);i.done(t.bind(function(){this.render()},this))},page:function(t){e.View.prototype.page.call(this,t),this.bufferAroundCurrentPage()},pageTo:function(t,i){"undefined"==typeof i&&(i=!1),e.View.prototype.pageTo.call(this,t,i),this.bufferAroundCurrentPage()}}),e.manualFilter=e.Filter.extend({cacheResults:function(){return!1},addCacheResults:function(){return!1},getFn:function(i){if(t.isArray(i))return i=i.sort(function(t,e){return t-e}),new e.MatchSet(i,this.getCollection(),[[this,i]]);if("number"==typeof i)return new e.MatchSet([i],this.getCollection(),[[this,i]]);throw"Manual filters only support querying by one or more cids"},addItems:function(i){if(t.isArray(i)||(i=[i]),i=i.sort(function(t,e){return t-e}),this.current_query)var n=this.current_query.cids,r=e.union_sorted(n,i);else var r=i;this.query(r)},removeItems:function(i){t.isArray(i)||(i=[i]),i=i.sort(function(t,e){return t-e});var n=this.current_query.cids,r=e.subtract_sorted(n,i);this.query(r)}}),e.makeManualFilter=function(t){var i=new e.manualFilter(t,[]);return i},e.exactFilter=e.Filter.extend({cacheResults:e.cacheMethods.exactCache,addCacheResults:e.cacheMethods.exactAddCache,getFn:function(i){var n=this;if(t.isArray(i)){var r=t.reduce(i,function(t,e){return t?t.or(n.getFn(e)):n.getFn(e)},!1);return r}var s=this.possibilities[i];if(t.isUndefined(s))throw"The filter "+this.name+" does not have a match for the query '"+i+"'.";return new e.MatchSet(s.matching_cids,this.getCollection(),[[this,i]])}}),e.makeExactFilter=function(i,n,r){"undefined"==typeof r&&(r={});var s=r.attr||i;return n=t.map(n,function(t){return{value:t}}),r=t.extend({associated_attrs:[s]},r),new e.exactFilter(i,n,r)},e.inclusionFilter=e.exactFilter.extend({cacheResults:e.cacheMethods.inclusionCache,addCacheResults:e.cacheMethods.inclusionAddCache}),e.makeInclusionFilter=function(i,n,r){"undefined"==typeof r&&(r={});var s=r.attr||i;return n=t.map(n,function(t){return{value:t}}),r=t.extend({associated_attrs:[s]},r),new e.inclusionFilter(i,n,r)},e.rangeFilter=e.Filter.extend({cacheResults:e.cacheMethods.defaultCache,addCacheResults:e.cacheMethods.defaultAddCache,fn:function(t,e){var i=this.attr||this.name;return t.low<=e[i]&&t.high>=e[i]},getFn:function(i){var n=this.possibilities[i.join("-")];if(t.isUndefined(n))throw"The filter "+this.name+" does not have a match for the query '"+i+"'.";return new e.MatchSet(n.matching_cids,this.getCollection(),[[this,i]])}}),e.makeRangeFilter=function(i,n,r){"undefined"==typeof r&&(r={});var s=t.map(n,function(t){return{low:t[0],high:t[1],value:t.join("-")}}),c=r.attr||i,a=t.extend({associated_attrs:[c]},r),o=new e.rangeFilter(i,s,a);return o},e.dvrangeFilter=e.Filter.extend({cacheResults:e.cacheMethods.exactCache,addCacheResults:e.cacheMethods.exactAddCache,getFn:function(i){if(!i[0]||!i[1])return new e.MatchSet([],this.getCollection(),[[this,i]]);var n,r,s,c,a;return n=t.indexOf(this.values,i[0]),r=t.indexOf(this.values,i[1]),s=this,c=t.map(this.values.slice(n,r+1),function(t){return s.possibilities[t]}),a=t.reduce(c,function(t,i){return e.union_sorted(t,i.matching_cids)},[]),new e.MatchSet(a,this.getCollection(),[[this,i]])}}),e.makeDVrangeFilter=function(i,n,r){"undefined"==typeof r&&(r={});var s=t.map(n,function(t){return{value:t}}),c=r.attr||i,a=t.extend({associated_attrs:[c]},r),o=new e.dvrangeFilter(i,s,a);return o},e.continuousRangeFilter=e.Filter.extend({cacheResults:function(e){this.values=t.map(e,function(t){return{cid:t.cid,val:t[this.name]}},this),this.values.sort(function(t,e){return t.val-e.val})},addCacheResults:function(t){this.values=this.values.concat(t),this.values.sort(function(t,e){return t.val-e.val})},getFn:function(i){var n,r,s=this.values.length,c=e.bisect_by(function(t){return t.val});if(t.isArray(i)){if(t.isUndefined(i[0])||t.isUndefined(i[1]))return new e.MatchSet([],this.getCollection(),[[this,i]]);n=c.left(this.values,i[0],0,s),r=c.left(this.values,i[1],0,s)}else{if(t.isUndefined(i))return new e.MatchSet([],this.getCollection(),[[this,i]]);n=c.left(this.values,i,0,s),r=c.right(this.values,i,0,s)}for(var a=[],o=n;r>o;)a.push(this.values[o].cid),++o;return a.sort(function(t,e){return t-e}),new e.MatchSet(a,this.getCollection(),[[this,i]])}}),e.makeContinuousRangeFilter=function(i,n){"undefined"==typeof n&&(n={});var r=n.attr||i,s=t.extend({associated_attrs:[r]},n),c=new e.continuousRangeFilter(i,s);return c},e.explicitSort=e.Sort.extend({fn:function(e,i){var n=t.indexOf(this.order,e[this.attr]),r=t.indexOf(this.order,i[this.attr]);return-1===n&&(n=1/0),-1===r&&(r=1/0),n-r},reset:function(e){this.order=t.pluck(e,this.attr),this.rebuild_sort()},insert:function(e,i){"undefined"==typeof i&&(i=this.order.length),t.isArray(e)||(e=[e]);var n=t.pluck(e,this.attr),r=[i,0].concat(n);this.order.splice.apply(this.order,r),this.rebuild_sort()},remove:function(e){t.isArray(e)||(e=[e]);var i=t.pluck(e,this.attr);this.order=t.difference(this.order,i),this.rebuild_sort()},move:function(e,i){t.isArray(e)||(e=[e]);var n=t.pluck(e,this.attr);this.order=t.map(this.order,function(e){return t.include(n,e)?null:e}),this.insert(e,i),this.order=t.compact(this.order)}}),e.makeExplicitSort=function(t,i,n,r,s){var c=new e.explicitSort(t,s);return c.associated_attrs=[n],c.order=r,c},e.reverseCidSort=e.Sort.extend({fn:function(t,e){return e.cid-t.cid}}),e.makeReverseCidSort=function(t,i){var n=new e.reverseCidSort(t);return n.associated_attrs=["cid"],n},e.UI.SimpleSelectElement=e.UI.Element.extend({initialize:function(t){if(!t.filter)throw"A simple select element must have a filter specified";this.filter=t.filter},getMatchSet:function(){return this.filter.current_query},getFilterState:function(){var t=this.getMatchSet();return this.getSimpleSelectState(t)}}),e.UI.SimpleDVRangeElement=e.UI.Element.extend({initialize:function(t){if(!t.filter)throw"A simple dv range element must have a filter specified";this.filter=t.filter},getMatchSet:function(){return this.filter.current_query},getFilterState:function(){var t=this.getMatchSet();return this.getSimpleRangeState(t)}}),e}();return e});